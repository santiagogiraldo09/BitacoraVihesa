<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Inspecci칩n de Obra</title>
    <link rel="icon" href="{{ url_for('static', filename='logo.png') }}" type="image/x-icon">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
    /* Estilos para las tarjetas de 칤tems din치micos */
    .dynamic-item-box {
        border: 1px solid #ddd;
        padding: 15px;
        margin-bottom: 25px;
        border-radius: 10px;
        background-color: #fcfcfc;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid #FFAF33;
        margin-bottom: 15px;
        padding-bottom: 5px;
    }
    .item-header h3 {
        margin: 0;
        color: #FFAF33;
    }
    .photo-thumbnail-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 200px;
        margin-top: 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 5px;
        background-color: #f9f9f9;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .thumbnail-image {
        width: 100%;
        height: 150px;
        object-fit: cover;
        border-radius: 4px;
        margin-bottom: 5px;
    }
</style>
</head>
<body>
    <div id="app">
        <header>
            <div id="logo-container">
                <img src="{{ url_for('static', filename='logo.png') }}" id="logo" alt="Logo">
            </div>
            <h1>Inspecci칩n T칠cnica de Obra</h1>
        </header>

        <input type="hidden" id="project-name">

        <div id="form-container">

            <div class="project-header-info" style="background: #f0f0f0; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em;">
                <div><strong>Proyecto:</strong> <span>{{ project.nombre if project else 'N/A' }}</span></div>
                <div><strong>Cliente:</strong> <span>{{ project.cliente if project else 'N/A' }}</span></div>
                <div><strong>N칰mero:</strong> <span>{{ project.numero if project else 'N/A' }}</span></div>
                <div><strong>Ubicaci칩n:</strong> <span>{{ project.ubicacion if project else 'N/A' }}</span></div>
            </div>

            <div class="form-group" style="background: #fff0e6; padding: 15px; border-radius: 8px; border-left: 5px solid #FFAF33; margin-bottom: 25px;">
                <label><strong>EDIFICACI칍N / ZONA:</strong></label>
                <div class="input-with-icon">
                    <input type="text" id="global_edificacion" placeholder="Ej: Torre 1 - Piso 5">
                    <button class="record-btn" data-target-input="global_edificacion" type="button">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button class="stop-btn" title="Detener grabaci칩n" style="display: none; color: red; border: none; background: none; cursor: pointer;">
                        <i class="fas fa-stop"></i>
                    </button>
                </div>
            </div>

            <div id="items-container">
                </div>

            <div class="centrar" style="margin-bottom: 20px;">
                <button type="button" id="add-item-btn" class="activate-camera-button" style="background-color: #FFAF33;">
                    <i class="fas fa-plus"></i> A침adir Nuevo 칈tem
                </button>
            </div>

            <div id="camera-container" style="display: none;">
                <video id="videoElement" autoplay playsinline muted></video>
                <canvas id="photoCanvas" style="display:none;"></canvas>
            </div>
            
            <div class="action-buttons-wrapper" style="display: none;">
                <div class="button-row">
                    <button id="take-photo" class="round-button" onclick="takePhoto()" title="Tomar Foto">
                        <i class="fas fa-camera"></i>
                    </button>
                    <button id="start-record-btn" class="round-button" title="Grabar Video">
                        <i class="fas fa-video"></i>
                    </button>
                    <button id="stop-record-btn" class="round-button" title="Detener Grabaci칩n">
                        <i class="fas fa-stop"></i>
                    </button>
                </div>
            </div>

            <div class="centrar">
                <button id="save-record" onclick="saveRecord()">Guardar registro</button>
            </div>

            <input type="hidden" id="base64-photo">
            <div id="successMessage" style="display:none;" class="centrar"></div>
            <div id="loading-overlay" class="loading-overlay">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <template id="inspection-template">
        <div class="dynamic-item-box">
            <div class="item-header">
                <h3 class="item-title">칈tem #1</h3>
                <button type="button" class="remove-item-btn" style="background:none; border:none; color:red; cursor:pointer; display:none;">
                    <i class="fas fa-trash-alt"></i> Eliminar
                </button>
            </div>

            <div class="form-group">
                <label>Elemento / 츼rea Inspeccionada:</label>
                <div class="input-with-icon">
                    <input type="text" class="field-elemento">
                    <button class="record-btn" title="Grabar respuesta"><i class="fas fa-microphone"></i></button>
                    <button class="stop-btn" title="Detener grabaci칩n" style="display: none;"><i class="fas fa-stop"></i></button>
                </div>
            </div>

            <div class="form-group">
                <label>Especificaci칩n T칠cnica (Planos / Memoria):</label>
                <div class="input-with-icon">
                    <input type="text" class="field-especificacion">
                    <button class="record-btn" title="Grabar respuesta"><i class="fas fa-microphone"></i></button>
                    <button class="stop-btn" title="Detener grabaci칩n" style="display: none;"><i class="fas fa-stop"></i></button>
                </div>
            </div>

            <div class="form-group">
                <label>Condici칩n Observada en Obra:</label>
                <div class="input-with-icon">
                    <input type="text" class="field-condicion">
                    <button class="record-btn" title="Grabar respuesta"><i class="fas fa-microphone"></i></button>
                    <button class="stop-btn" title="Detener grabaci칩n" style="display: none;"><i class="fas fa-stop"></i></button>
                </div>
            </div>

            <div class="form-group">
                <label>Cumple (S칤/No):</label>
                <div class="input-with-icon">
                    <select class="field-cumple form-input" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc;">
                        <option value="">Seleccione...</option>
                        <option value="S칤">S칤</option>
                        <option value="No">No</option>
                        <option value="N/A">N/A</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Observaciones:</label>
                <div class="input-with-icon">
                    <input type="text" class="field-observaciones">
                    <button class="record-btn" title="Grabar respuesta"><i class="fas fa-microphone"></i></button>
                    <button class="stop-btn" title="Detener grabaci칩n" style="display: none;"><i class="fas fa-stop"></i></button>
                </div>
            </div>

            <div class="form-group">
                <label>Acciones Correctivas (si aplica):</label>
                <div class="input-with-icon">
                    <input type="text" class="field-acciones">
                    <button class="record-btn" title="Grabar respuesta"><i class="fas fa-microphone"></i></button>
                    <button class="stop-btn" title="Detener grabaci칩n" style="display: none;"><i class="fas fa-stop"></i></button>
                </div>
            </div>

            <div class="multimedia-item-section" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
                <div class="centrar" style="margin-bottom: 10px;">
                    <button class="activate-camera-button btn-item-camera" style="width: auto; padding: 10px 20px;">
                        <i class="fas fa-camera"></i> Activar C치mara
                    </button>
                </div>

                <div class="attachment-controls">
                    <label>Adjuntar Evidencia:</label>
                    <div class="button-row">
                        <button class="clip-button btn-item-photo-attach" title="Adjuntar imagen">游늹</button>
                        <input type="file" class="item-file-input" accept="image/*" multiple style="display:none;">
                        
                        <button class="clip-button btn-item-video-attach" title="Adjuntar video">游꿘</button>
                        <input type="file" class="item-video-input" accept="video/*" style="display:none;">
                    </div>
                </div>

                <div class="item-gallery-container">
                    <div class="item-photo-thumbnails photo-thumbnails"></div>
                    <div class="item-video-thumbnails photo-thumbnails"></div>
                </div>
            </div>
        </div>
    </template>

    <script src="{{ url_for('static', filename='script.js') }}"></script>

    <script>
        let itemCount = 0;
        let activeItemIdx = null; // Para saber qu칠 칤tem est치 usando la c치mara

        function addItem() {
            itemCount++;
            const container = document.getElementById('items-container');
            const template = document.getElementById('inspection-template');
            const clone = template.content.cloneNode(true);
            const box = clone.querySelector('.dynamic-item-box');
            
            const currentIdx = itemCount - 1;
            box.setAttribute('data-index', currentIdx);
            box.querySelector('.item-title').innerText = `칈tem #${itemCount}`;
            
            // Configurar IDs 칰nicos para funciones de voz
            const inputs = box.querySelectorAll('input[type="text"]');
            inputs.forEach((input, index) => {
                const uniqueId = `item_${itemCount}_input_${index}`;
                input.id = uniqueId;
                const recordBtn = input.nextElementSibling;
                const stopBtn = recordBtn.nextElementSibling;
                if(recordBtn) recordBtn.setAttribute('data-target-input', uniqueId);
                if(stopBtn) stopBtn.setAttribute('data-target-input', uniqueId);
            });

            // L칩gica de botones multimedia por 칤tem
            const itemCameraBtn = box.querySelector('.btn-item-camera');
            const itemPhotoAttach = box.querySelector('.btn-item-photo-attach');
            const itemVideoAttach = box.querySelector('.btn-item-video-attach');
            const itemFileInput = box.querySelector('.item-file-input');
            const itemVideoInput = box.querySelector('.item-video-input');

            // --- LAS L칈NEAS QUE DEBES ASEGURAR QUE EST칄N AQU칈 ---
            itemFileInput.onchange = (e) => handleLocalFiles(e, currentIdx, 'foto');
            itemVideoInput.onchange = (e) => handleLocalFiles(e, currentIdx, 'video');
            // --------------------------------------------------

            itemCameraBtn.onclick = function() {
                activeItemIdx = currentIdx;
                document.getElementById('camera-container').style.display = 'block';
                document.querySelector('.action-buttons-wrapper').style.display = 'block';
                
                if (typeof startCamera === 'function') {
                    startCamera();
                } else {
                    console.error("La funci칩n startCamera no est치 definida en script.js");
                }
            };

            itemPhotoAttach.onclick = () => itemFileInput.click();
            itemVideoAttach.onclick = () => itemVideoInput.click();

            if (itemCount > 1) {
                const removeBtn = box.querySelector('.remove-item-btn');
                removeBtn.style.display = 'block';
                removeBtn.onclick = function() {
                    box.remove();
                    reindexItems();
                };
            }

            container.appendChild(clone);
            
            if (typeof setupVoiceButtons === "function") {
                setupVoiceButtons();
            }
        }

        function reindexItems() {
            const boxes = document.querySelectorAll('.dynamic-item-box');
            itemCount = 0;
            boxes.forEach((box) => {
                itemCount++;
                box.setAttribute('data-index', itemCount - 1);
                box.querySelector('.item-title').innerText = `칈tem #${itemCount}`;
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            addItem();
            document.getElementById('add-item-btn').addEventListener('click', addItem);

            const urlParams = new URLSearchParams(window.location.search);
            const projectName = urlParams.get('project');
            if (projectName) {
                document.getElementById('project-name').value = projectName;
            }
        });
    </script>
</body>
</html>